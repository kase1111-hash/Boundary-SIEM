#include <tunables/global>

# Boundary-SIEM Container AppArmor Profile
# Load with: apparmor_parser -r -W /path/to/boundary-siem
# Verify with: aa-status

profile boundary-siem flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # ==========================================================================
  # Network Access
  # ==========================================================================

  # Allow network access for syslog ingestion and API
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,
  network unix stream,
  network unix dgram,
  network netlink raw,

  # ==========================================================================
  # File System Access
  # ==========================================================================

  # Binary execution
  /usr/local/bin/boundary-siem mr,

  # Read-only access to system files
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/hosts r,
  /etc/resolv.conf r,
  /etc/ssl/** r,
  /etc/ca-certificates/** r,
  /usr/share/ca-certificates/** r,
  /usr/share/zoneinfo/** r,

  # Configuration directory - read only
  /etc/boundary-siem/ r,
  /etc/boundary-siem/** r,

  # Data directory - read/write
  /var/lib/boundary-siem/ rw,
  /var/lib/boundary-siem/** rwk,

  # Log directory - read/write/append
  /var/log/boundary-siem/ rw,
  /var/log/boundary-siem/** rwk,

  # Temporary files
  /tmp/ rw,
  /tmp/** rwk,
  /run/ r,
  /run/** rw,

  # Proc filesystem - limited access
  @{PROC}/ r,
  @{PROC}/sys/kernel/random/uuid r,
  @{PROC}/sys/kernel/hostname r,
  @{PROC}/sys/net/** r,
  @{PROC}/[0-9]*/stat r,
  @{PROC}/[0-9]*/status r,
  @{PROC}/[0-9]*/fd/ r,
  @{PROC}/[0-9]*/cmdline r,
  @{PROC}/[0-9]*/cgroup r,
  @{PROC}/[0-9]*/mountinfo r,
  @{PROC}/[0-9]*/mounts r,

  # Sys filesystem - limited access
  /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
  /sys/fs/cgroup/** r,

  # Device access - minimal
  /dev/null rw,
  /dev/zero r,
  /dev/urandom r,
  /dev/random r,
  /dev/tty rw,
  /dev/pts/* rw,

  # ==========================================================================
  # Capabilities
  # ==========================================================================

  # Network capabilities
  capability net_bind_service,

  # File capabilities (for immutable logs)
  # capability linux_immutable,

  # Deny dangerous capabilities explicitly
  deny capability sys_admin,
  deny capability sys_ptrace,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_boot,
  deny capability sys_nice,
  deny capability sys_resource,
  deny capability sys_time,
  deny capability mknod,
  deny capability net_admin,
  deny capability net_raw,
  deny capability ipc_lock,
  deny capability ipc_owner,
  deny capability kill,
  deny capability setuid,
  deny capability setgid,
  deny capability dac_override,
  deny capability dac_read_search,
  deny capability chown,
  deny capability fowner,
  deny capability fsetid,

  # ==========================================================================
  # Signal Handling
  # ==========================================================================

  signal (receive) peer=unconfined,
  signal (send,receive) peer=boundary-siem,

  # ==========================================================================
  # Deny Rules - Explicit security restrictions
  # ==========================================================================

  # Deny mounting
  deny mount,
  deny umount,
  deny pivot_root,

  # Deny ptrace
  deny ptrace,

  # Deny raw socket access (except for allowed network)
  deny network raw,
  deny network packet,

  # Deny access to sensitive paths
  deny /etc/shadow r,
  deny /etc/gshadow r,
  deny /etc/sudoers r,
  deny /etc/sudoers.d/** r,
  deny /root/** rwx,
  deny /home/** rwx,

  # Deny writing to system directories
  deny /bin/** w,
  deny /sbin/** w,
  deny /usr/** w,
  deny /lib/** w,
  deny /lib64/** w,
  deny /boot/** rwx,

  # Deny kernel module operations
  deny /lib/modules/** rwx,
  deny @{PROC}/sys/kernel/modprobe w,

  # Deny cgroup modifications
  deny /sys/fs/cgroup/** w,
}

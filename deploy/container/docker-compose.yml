# Boundary-SIEM Docker Compose Configuration
# Secure container deployment with network isolation
#
# Usage:
#   docker-compose up -d              # Start services
#   docker-compose logs -f siem       # View logs
#   docker-compose down               # Stop services
#
# Security Features:
#   - Isolated networks (internal, ingestion, management)
#   - Read-only root filesystem
#   - No new privileges
#   - Dropped capabilities
#   - Resource limits
#   - Security profiles (seccomp, AppArmor)

version: "3.9"

# =============================================================================
# Networks - Isolated network segments
# =============================================================================
networks:
  # Internal network - no external access
  siem-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/24
          gateway: 172.28.0.1

  # Ingestion network - receives syslog from external sources
  siem-ingestion:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.1.0/24
          gateway: 172.28.1.1
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"

  # Management network - for admin access only
  siem-management:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.2.0/24
          gateway: 172.28.2.1

# =============================================================================
# Volumes - Persistent storage
# =============================================================================
volumes:
  siem-data:
    driver: local
  siem-logs:
    driver: local
  siem-config:
    driver: local

# =============================================================================
# Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # Main SIEM Service
  # ---------------------------------------------------------------------------
  siem:
    build:
      context: ../..
      dockerfile: deploy/container/Dockerfile
      target: runtime
    image: boundary-siem:latest
    container_name: boundary-siem
    hostname: boundary-siem
    restart: unless-stopped

    # Network isolation
    networks:
      siem-internal:
        ipv4_address: 172.28.0.10
      siem-ingestion:
        ipv4_address: 172.28.1.10
      siem-management:
        ipv4_address: 172.28.2.10

    # Port mappings - only expose what's needed
    ports:
      # Syslog ingestion (only on ingestion network interface)
      - "172.28.1.1:5514:5514/tcp"    # Syslog TCP/TLS
      - "172.28.1.1:5514:5514/udp"    # Syslog UDP
      - "172.28.1.1:5515:5515/udp"    # Syslog UDP (alt)
      # Management API (only on management network)
      - "172.28.2.1:8443:8443/tcp"    # HTTPS API

    # Volume mounts
    volumes:
      - siem-data:/var/lib/boundary-siem:rw
      - siem-logs:/var/log/boundary-siem:rw
      - siem-config:/etc/boundary-siem:ro
      # Mount seccomp profile
      - ./seccomp-profile.json:/etc/seccomp/profile.json:ro

    # Environment variables
    environment:
      - TZ=UTC
      - SIEM_LOG_LEVEL=info
      - SIEM_LOG_FORMAT=json
      - SIEM_DATA_DIR=/var/lib/boundary-siem
      - SIEM_LOG_DIR=/var/log/boundary-siem
      - SIEM_CONFIG=/etc/boundary-siem/config.yaml
      # Disable color output in logs
      - NO_COLOR=1

    # Security configuration
    security_opt:
      # Use custom seccomp profile
      - seccomp=./seccomp-profile.json
      # Use AppArmor profile (must be loaded on host)
      - apparmor=boundary-siem
      # Disable privilege escalation
      - no-new-privileges:true

    # Capability management - drop all, add only what's needed
    cap_drop:
      - ALL
    cap_add:
      # Required for binding to privileged ports (< 1024)
      - NET_BIND_SERVICE
      # Required for chattr immutable logs (optional)
      # - LINUX_IMMUTABLE

    # Read-only root filesystem
    read_only: true

    # Temporary filesystems for runtime needs
    tmpfs:
      - /tmp:size=64M,mode=1777,noexec,nosuid
      - /run:size=16M,mode=755,noexec,nosuid

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["/usr/local/bin/boundary-siem", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

    # User/group - run as non-root
    user: "65534:65534"

    # Don't allow container to gain additional privileges
    privileged: false

    # Dependencies
    depends_on:
      - siem-init

  # ---------------------------------------------------------------------------
  # Init Container - Sets up directories and permissions
  # ---------------------------------------------------------------------------
  siem-init:
    image: alpine:3.19
    container_name: boundary-siem-init
    command:
      - /bin/sh
      - -c
      - |
        # Create directories with proper permissions
        mkdir -p /data/db /data/cache /data/state
        mkdir -p /logs/audit /logs/app /logs/security
        mkdir -p /config

        # Set ownership (65534 = nobody)
        chown -R 65534:65534 /data /logs
        chmod -R 750 /data /logs
        chmod 755 /config

        echo "Initialization complete"
    volumes:
      - siem-data:/data
      - siem-logs:/logs
      - siem-config:/config
    networks:
      - siem-internal
    restart: "no"

  # ---------------------------------------------------------------------------
  # Syslog Forwarder - Optional external syslog relay
  # ---------------------------------------------------------------------------
  syslog-relay:
    image: alpine:3.19
    container_name: boundary-siem-syslog-relay
    hostname: syslog-relay
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache socat
        # Relay syslog from external network to SIEM
        socat -d UDP4-LISTEN:514,fork,reuseaddr UDP4:172.28.1.10:5514
    networks:
      siem-ingestion:
        ipv4_address: 172.28.1.20
    ports:
      - "514:514/udp"
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
    profiles:
      - relay

  # ---------------------------------------------------------------------------
  # Network Monitor - Monitors container network traffic
  # ---------------------------------------------------------------------------
  network-monitor:
    image: alpine:3.19
    container_name: boundary-siem-netmon
    hostname: netmon
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache tcpdump
        # Monitor for suspicious traffic patterns
        tcpdump -i any -n -l 'not port 5514 and not port 8443' | while read line; do
          echo "ALERT: Unexpected traffic: $line" >> /var/log/netmon.log
        done
    networks:
      siem-internal:
        ipv4_address: 172.28.0.254
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW
      - NET_ADMIN
    read_only: true
    volumes:
      - siem-logs:/var/log:rw
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
    profiles:
      - monitoring

# =============================================================================
# Extension fields for common configurations
# =============================================================================
x-common-security: &common-security
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  read_only: true

x-common-logging: &common-logging
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
